<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ìš´ë¹¨ ì¡´ë§ ë””íœìŠ¤ V8.0</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Black+Han+Sans&family=Do+Hyeon&display=swap');
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; background-color: #000; color: white; font-family: 'Do Hyeon', sans-serif; overflow: hidden; touch-action: none; width: 100vw; height: 100vh; }
        
        #app { position: relative; width: 100%; height: 100%; background: #121212; display: flex; flex-direction: column; }
        .screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; flex-direction: column; background: #121212; z-index: 10; }
        .screen.active { display: flex; }

        /* ê²Œì„ ì˜ì—­ */
        #game-screen { position: relative; flex: 1; background: #1a1a2e; overflow: hidden; }
        canvas { display: block; width: 100%; height: 100%; position: absolute; top: 0; left: 0; z-index: 1; }
        
        /* UI ë ˆì´ì–´ */
        #game-ui { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 5; display: flex; flex-direction: column; justify-content: space-between; }
        .game-top-bar { padding: 10px 15px; background: rgba(0,0,0,0.7); display: flex; justify-content: space-between; align-items: center; font-size: 18px; color: #fff; }
        .time-bar-container { position: absolute; top: 45px; left: 0; width: 100%; height: 6px; background: rgba(255,255,255,0.2); }
        .time-bar-fill { height: 100%; background: #00f2fe; width: 100%; transition: width 0.1s linear; box-shadow: 0 0 10px #00f2fe; }

        /* í•˜ë‹¨ ì»¨íŠ¸ë¡¤ */
        .game-footer { padding: 10px; background: #111; pointer-events: auto; border-top: 1px solid #444; display: flex; flex-direction: column; gap: 8px; z-index: 100; }
        .control-row { display: flex; justify-content: space-between; align-items: center; margin-top: 5px; }
        
        /* ê³µí†µ ìŠ¤íƒ€ì¼ */
        .header { height: 50px; background: #1f1f1f; display: flex; justify-content: space-between; align-items: center; padding: 0 15px; border-bottom: 2px solid #333; color: #ffcc00; }
        #tab-bar { height: 60px; background: #1a1a1a; display: flex; justify-content: space-around; align-items: center; border-top: 1px solid #333; z-index: 100; }
        .tab-item { flex: 1; text-align: center; color: #666; cursor: pointer; font-size: 11px; }
        .tab-item.active { color: #00f2fe; }
        .locked-tab { opacity: 0.3; pointer-events: none; }
        .btn { background: linear-gradient(180deg, #4facfe, #00f2fe); border: none; border-radius: 8px; color: #000; font-family: 'Black Han Sans'; padding: 10px; font-size: 18px; cursor: pointer; width: 100%; font-weight: bold; }
        .speed-btn { background: #333; color: #fff; border: none; padding: 5px 12px; border-radius: 20px; font-size: 12px; }
        .speed-btn.active { background: #ffcc00; color: #000; }
        
        .content-scroll { flex: 1; overflow-y: auto; padding: 15px; }
        .stage-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .stage-btn { aspect-ratio: 1; background: #2a2a2a; border-radius: 8px; display: flex; justify-content: center; align-items: center; font-size: 14px; color: #555; border: 1px solid #333; }
        .stage-btn.unlocked { color: #fff; border-color: #00f2fe; }
        .stage-btn.cleared { color: #00ff00; border-color: #00ff00; background: #002200; }

        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 200; display: none; justify-content: center; align-items: center; }
        .modal-content { background: #222; padding: 30px; border-radius: 15px; text-align: center; border: 1px solid #555; width: 80%; }
    </style>
</head>
<body>

<div id="app">
    <div id="start-screen" class="screen active" style="justify-content: center; align-items: center; background: radial-gradient(#2b1055, #000);">
        <h1 style="color: #00f2fe; font-size: 45px; text-align: center; margin-bottom: 30px;">ìš´ë¹¨ ì¡´ë§<br>ë””íœìŠ¤</h1>
        <button class="btn" onclick="GameApp.changeState('LOBBY')" style="width: 200px; height: 60px;">ì‹œì‘í•˜ê¸°</button>
    </div>

    <div id="lobby-screen" class="screen">
        <div class="header"><span>ìŠ¤í…Œì´ì§€ ì„ íƒ</span><span id="lobby-coin">ğŸ’° 0</span></div>
        <div class="content-scroll" id="stage-list-container"></div>
    </div>

    <div id="shop-screen" class="screen">
        <div class="header"><span>ìƒì </span><span id="shop-coin">ğŸ’° 0</span></div>
        <div class="content-scroll" id="shop-container">
            <p style="text-align: center; color: #888;">ìƒì  ì‹œìŠ¤í…œ ì¤€ë¹„ ì¤‘...</p>
        </div>
    </div>

    <div id="game-screen" class="screen">
        <canvas id="gameCanvas"></canvas>
        <div id="game-ui">
            <div>
                <div class="game-top-bar"><span id="game-stage-txt">1-1</span><span id="game-life-txt">â¤ï¸ 3</span></div>
                <div class="time-bar-container"><div class="time-bar-fill" id="time-bar"></div></div>
            </div>
            <div class="game-footer">
                <div class="control-row">
                    <span style="font-size: 18px;">SP: <b id="game-sp-txt" style="color:#00f2fe">0</b></span>
                    <div>
                        <button class="speed-btn active" id="sp1" onclick="Game.setSpeed(1)">x1</button>
                        <button class="speed-btn" id="sp2" onclick="Game.setSpeed(2)">x2</button>
                    </div>
                </div>
                <button class="btn" id="spawn-btn" onclick="Game.spawnDice()">ì£¼ì‚¬ìœ„ ì†Œí™˜ (10 SP)</button>
            </div>
        </div>
    </div>

    <div id="tab-bar">
        <div class="tab-item active" id="tab-l" onclick="GameApp.changeState('LOBBY')">ì „íˆ¬</div>
        <div class="tab-item locked-tab" id="tab-s" onclick="GameApp.changeState('SHOP')">ìƒì </div>
        <div class="tab-item locked-tab">ì„¤ì •</div>
    </div>
</div>

<div id="result-modal" class="modal">
    <div class="modal-content">
        <h2 id="result-title" style="color:#00f2fe; font-size: 30px;"></h2>
        <p id="result-msg" style="margin: 20px 0; font-size: 18px;"></p>
        <button class="btn" onclick="Game.quitGame()">ë©”ì¸ìœ¼ë¡œ</button>
    </div>
</div>

<script>
/** V8.0 Final Logic - GitHub Pages Optimized **/
const DATA = {
    stages: [6, 10, 10, 14, 14],
    dice: { fire: '#ff4b2b', ice: '#00f2fe', poison: '#38ef7d', sniper: '#d53369' }
};

let player = { coins: 100, progress: { w: 1, s: 0 }, diceLv: {fire:1,ice:1,poison:1,sniper:1} };

const GameApp = {
    state: 'START',
    init() {
        this.renderLobby();
        this.checkUnlocks();
        Game.setup();
    },
    changeState(s) {
        this.state = s; // í•µì‹¬: ìƒíƒœ ë³€ìˆ˜ ì—…ë°ì´íŠ¸!
        document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
        document.getElementById('tab-bar').style.display = 'flex';
        
        if (s === 'LOBBY') {
            document.getElementById('lobby-screen').classList.add('active');
            this.renderLobby();
        } else if (s === 'SHOP') {
            document.getElementById('shop-screen').classList.add('active');
        } else if (s === 'GAME') {
            document.getElementById('game-screen').classList.add('active');
            document.getElementById('tab-bar').style.display = 'none';
        }
        this.checkUnlocks();
    },
    isCleared(w, s) { return player.progress.w > w || (player.progress.w == w && player.progress.s >= s); },
    checkUnlocks() {
        if(this.isCleared(1,6)) document.getElementById('tab-s').classList.remove('locked-tab');
        document.getElementById('lobby-coin').innerText = "ğŸ’° " + player.coins;
    },
    renderLobby() {
        const c = document.getElementById('stage-list-container');
        c.innerHTML = '';
        DATA.stages.forEach((max, i) => {
            const w = i + 1;
            const worldTitle = document.createElement('div');
            worldTitle.style.cssText = "margin:20px 0 10px; color:#ffcc00; font-size:20px; border-left:4px solid #00f2fe; padding-left:10px;";
            worldTitle.innerText = `WORLD ${w}`;
            c.appendChild(worldTitle);

            const grid = document.createElement('div');
            grid.className = 'stage-grid';
            for(let s=1; s<=max; s++) {
                const b = document.createElement('div');
                b.className = 'stage-btn';
                b.innerText = `${w}-${s}`;
                
                const cleared = this.isCleared(w, s);
                const unlocked = cleared || (player.progress.w === w && player.progress.s === s-1) || (w > 1 && s === 1 && this.isCleared(w-1, DATA.stages[w-2]));
                
                if(cleared) b.classList.add('cleared');
                else if(unlocked) {
                    b.classList.add('unlocked');
                    b.onclick = () => Game.start(w, s);
                } else {
                    b.innerHTML = 'ğŸ”’';
                }
                grid.appendChild(b);
            }
            c.appendChild(grid);
        });
    }
};

const Game = {
    setup() {
        this.cvs = document.getElementById('gameCanvas');
        this.ctx = this.cvs.getContext('2d');
        window.addEventListener('resize', () => this.resize());
        // í„°ì¹˜/í´ë¦­ ì´ë²¤íŠ¸
        this.cvs.addEventListener('mousedown', (e) => this.click(e));
    },
    resize() {
        const rect = document.getElementById('game-screen').getBoundingClientRect();
        this.cvs.width = rect.width;
        this.cvs.height = rect.height;
        this.w = this.cvs.width;
        this.h = this.cvs.height;
    },
    start(w, s) {
        GameApp.changeState('GAME');
        this.resize();
        this.st = { world:w, stage:s, sp:0, cost:10, hp:3, time:90, f:0, speed:1 };
        this.ents = { grid: Array(4).fill().map(()=>Array(4).fill(null)), enemies:[], bullets:[] };
        this.updateUI();
        
        if(this.loopId) cancelAnimationFrame(this.loopId);
        this.loop();
    },
    click(e) {
        const rect = this.cvs.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        const sz = Math.min(this.w, this.h) / 5;
        const ox = (this.w - sz*4)/2;
        const oy = (this.h - sz*4)/2;
        
        if(x > ox && x < ox + sz*4 && y > oy && y < oy + sz*4) {
            const c = Math.floor((x-ox)/sz);
            const r = Math.floor((y-oy)/sz);
            const dice = this.ents.grid[r][c];
            if(dice && this.selected && this.selected !== dice && this.selected.t === dice.t) {
                // ë¨¸ì§€ ì‹œìŠ¤í…œ
                this.ents.grid[this.selected.r][this.selected.c] = null;
                dice.lv++;
                dice.t = Object.keys(DATA.dice)[Math.floor(Math.random()*4)];
                this.selected = null;
            } else {
                this.selected = dice;
            }
        }
    },
    spawnDice() {
        if(this.st.sp < this.st.cost) return;
        let empty = [];
        for(let r=0;r<4;r++) for(let c=0;c<4;c++) if(!this.ents.grid[r][c]) empty.push({r,c});
        if(!empty.length) return;

        this.st.sp -= this.st.cost;
        this.st.cost += 10;
        const p = empty[Math.floor(Math.random()*empty.length)];
        const types = Object.keys(DATA.dice);
        this.ents.grid[p.r][p.c] = { r:p.r, c:p.c, t: types[Math.floor(Math.random()*types.length)], lv:1, cd:0 };
        this.updateUI();
    },
    setSpeed(v) {
        this.st.speed = v;
        document.getElementById('sp1').classList.toggle('active', v===1);
        document.getElementById('sp2').classList.toggle('active', v===2);
    },
    updateUI() {
        document.getElementById('game-stage-txt').innerText = `${this.st.world}-${this.st.stage}`;
        document.getElementById('game-sp-txt').innerText = Math.floor(this.st.sp);
        document.getElementById('spawn-btn').innerText = `ì£¼ì‚¬ìœ„ ì†Œí™˜ (${this.st.cost} SP)`;
        document.getElementById('game-life-txt').innerText = `â¤ï¸ ${this.st.hp}`;
    },
    loop() {
        if(GameApp.state !== 'GAME') return; // ê²Œì„ ì¤‘ì¼ ë•Œë§Œ ì‹¤í–‰
        
        this.st.f++;
        if(this.st.f % 60 === 0) {
            this.st.time--;
            if(this.st.time <= 0) this.end(true);
            document.getElementById('time-bar').style.width = (this.st.time/90)*100 + "%";
        }
        if(this.st.f % 30 === 0) { this.st.sp += 1 * this.st.speed; this.updateUI(); }
        
        // ì  ìŠ¤í°
        if(this.st.f % Math.max(20, (100 - this.st.world*10)) === 0) {
            this.ents.enemies.push({ x: this.w * 0.1, y: 0, hp: 50 + this.st.world*30, m: 50 + this.st.world*30 });
        }

        // ê·¸ë¦¬ê¸° ì‹œì‘
        this.ctx.fillStyle = '#1a1a2e';
        this.ctx.fillRect(0, 0, this.w, this.h);

        // ìº”ë²„ìŠ¤ ì‘ë™ í…ŒìŠ¤íŠ¸ìš© ë¬¸êµ¬ (ì²˜ìŒì—ë§Œ ë³´ì„)
        if(this.st.f < 100) {
            this.ctx.fillStyle = "white";
            this.ctx.textAlign = "center";
            this.ctx.fillText("SYSTEM ONLINE", this.w/2, this.h/2);
        }

        // ì  ì´ë™ ë° ê·¸ë¦¬ê¸°
        this.ents.enemies.forEach((e, i) => {
            e.y += (1.5 + this.st.world*0.2) * this.st.speed;
            this.ctx.fillStyle = 'red';
            this.ctx.beginPath();
            this.ctx.arc(e.x, e.y, 12, 0, Math.PI*2);
            this.ctx.fill();
            // HP ë°”
            this.ctx.fillStyle = '#00ff00';
            this.ctx.fillRect(e.x-10, e.y-20, 20 * (e.hp/e.m), 3);
            
            if(e.y > this.h) {
                this.ents.enemies.splice(i, 1);
                this.st.hp--;
                this.updateUI();
                if(this.st.hp <= 0) this.end(false);
            }
        });

        // ì£¼ì‚¬ìœ„ ê·¸ë¦¬ê¸° ë° ê³µê²©
        const sz = Math.min(this.w, this.h) / 5;
        const ox = (this.w - sz*4)/2;
        const oy = (this.h - sz*4)/2;

        this.ents.grid.forEach(row => row.forEach(d => {
            if(!d) return;
            const dx = ox + d.c*sz + sz/2;
            const dy = oy + d.r*sz + sz/2;
            
            this.ctx.fillStyle = DATA.dice[d.t];
            this.ctx.fillRect(dx - sz*0.4, dy - sz*0.4, sz*0.8, sz*0.8);
            this.ctx.fillStyle = "white";
            this.ctx.textAlign = "center";
            this.ctx.fillText(d.lv, dx, dy + 5);

            if(this.selected === d) {
                this.ctx.strokeStyle = "white";
                this.ctx.lineWidth = 3;
                this.ctx.strokeRect(dx-sz*0.4, dy-sz*0.4, sz*0.8, sz*0.8);
            }

            // ê³µê²© ë¡œì§
            if(d.cd-- <= 0 && this.ents.enemies.length) {
                const target = this.ents.enemies[0];
                target.hp -= 10 * d.lv;
                if(target.hp <= 0) this.ents.enemies.shift();
                d.cd = 60 / this.st.speed;
                // ê³µê²©ì„  ê·¸ë¦¬ê¸°
                this.ctx.strokeStyle = DATA.dice[d.t];
                this.ctx.beginPath();
                this.ctx.moveTo(dx, dy);
                this.ctx.lineTo(target.x, target.y);
                this.ctx.stroke();
            }
        }));

        this.loopId = requestAnimationFrame(() => this.loop());
    },
    end(win) {
        cancelAnimationFrame(this.loopId);
        const modal = document.getElementById('result-modal');
        const title = document.getElementById('result-title');
        const msg = document.getElementById('result-msg');
        
        if(win) {
            title.innerText = "STAGE CLEAR!";
            msg.innerText = "ë³´ìƒìœ¼ë¡œ 100 ì½”ì¸ì„ íšë“í–ˆìŠµë‹ˆë‹¤!";
            player.coins += 100;
            if(this.st.world === player.progress.w && this.st.stage > player.progress.s) {
                player.progress.s = this.st.stage;
                if(player.progress.s >= DATA.stages[this.st.world-1]) {
                    player.progress.w++;
                    player.progress.s = 0;
                }
            }
        } else {
            title.innerText = "GAME OVER";
            title.style.color = "red";
            msg.innerText = "ì•ˆíƒ€ê¹êµ°ìš”! ë‹¤ì‹œ ë„ì „í•´ë³´ì„¸ìš”.";
        }
        modal.style.display = 'flex';
    },
    quitGame() {
        document.getElementById('result-modal').style.display = 'none';
        GameApp.changeState('LOBBY');
    }
};

window.onload = () => GameApp.init();
</script>
</body>
</html>
