<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ìš´ë¹¨ ì¡´ë§ ë””íœìŠ¤ V6.0 (Auto-Resize)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Black+Han+Sans&family=Do+Hyeon&display=swap');

        /* 1. ê¸°ë³¸ ì„¤ì • ë° ë¦¬ì…‹ */
        * { box-sizing: border-box; }
        body { margin: 0; padding: 0; background-color: #000; color: white; font-family: 'Do Hyeon', sans-serif; overflow: hidden; touch-action: none; width: 100vw; height: 100vh; }
        
        /* 2. ì „ì²´ ì•± ì»¨í…Œì´ë„ˆ */
        #app { position: relative; width: 100%; height: 100%; background: #121212; display: flex; flex-direction: column; overflow: hidden; }

        /* 3. í™”ë©´ ê´€ë¦¬ (ì ˆëŒ€ ìœ„ì¹˜ë¡œ ê²¹ì³ë‘ ) */
        .screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; flex-direction: column; background: #121212; z-index: 10; }
        .screen.active { display: flex; }

        /* 4. ê²Œì„ í™”ë©´ ë° ìº”ë²„ìŠ¤ (ì¤‘ìš”!) */
        #game-screen { position: relative; width: 100%; height: 100%; background: #1a1a2e; /* JS ì‹¤íŒ¨í•´ë„ ë°°ê²½ìƒ‰ ë³´ì„ */ }
        canvas { 
            display: block; 
            width: 100%; height: 100%; 
            position: absolute; top: 0; left: 0; 
            z-index: 1; 
            touch-action: none;
        }
        
        /* 5. UI ì˜¤ë²„ë ˆì´ */
        #game-ui { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 5; display: flex; flex-direction: column; justify-content: space-between; }
        
        /* ìƒë‹¨ UI */
        .game-top-bar { padding: 10px 15px; background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent); display: flex; justify-content: space-between; align-items: center; color: white; font-size: 18px; text-shadow: 1px 1px 2px black; }
        .time-bar-container { position: absolute; top: 40px; left: 0; width: 100%; height: 6px; background: rgba(255,255,255,0.2); }
        .time-bar-fill { height: 100%; background: #00f2fe; width: 100%; transition: width 0.1s linear; box-shadow: 0 0 10px #00f2fe; }

        /* í•˜ë‹¨ UI */
        .game-footer { padding: 10px; background: rgba(0,0,0,0.9); pointer-events: auto; border-top: 1px solid #444; display: flex; flex-direction: column; gap: 8px; }
        
        /* ê¸°íƒ€ UI ìŠ¤íƒ€ì¼ */
        .header { height: 50px; background: #1f1f1f; display: flex; justify-content: space-between; align-items: center; padding: 0 15px; border-bottom: 2px solid #333; font-size: 18px; color: #ffcc00; flex-shrink: 0; }
        #tab-bar { height: 60px; background: #1a1a1a; display: flex; justify-content: space-around; align-items: center; border-top: 1px solid #333; z-index: 100; flex-shrink: 0; }
        .tab-item { flex: 1; text-align: center; color: #666; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; font-size: 11px; }
        .tab-item.active { color: #00f2fe; background: rgba(255,255,255,0.05); }
        .locked-tab { filter: grayscale(1); opacity: 0.3; pointer-events: none; }
        .btn { background: linear-gradient(180deg, #4facfe 0%, #00f2fe 100%); border: none; border-radius: 8px; color: white; font-family: 'Black Han Sans', sans-serif; padding: 8px 16px; font-size: 16px; cursor: pointer; box-shadow: 0 3px 0 #005f73; }
        .btn:active { transform: translateY(3px); box-shadow: none; }
        .btn-buy { background: linear-gradient(180deg, #f093fb 0%, #f5576c 100%); box-shadow: 0 3px 0 #a00000; font-size: 14px; padding: 5px 10px; }
        .btn-equip { background: linear-gradient(180deg, #43e97b 0%, #38f9d7 100%); box-shadow: 0 3px 0 #006622; font-size: 14px; padding: 5px 10px; color: #004400; }
        
        .skill-bar { display: flex; justify-content: center; gap: 10px; margin-bottom: 5px; }
        .skill-btn { width: 50px; height: 50px; border-radius: 10px; border: 2px solid #555; background: #222; color: #fff; font-size: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; position: relative; overflow: hidden; }
        .skill-btn.active { border-color: #ffcc00; background: #333; }
        .skill-btn.cooldown { filter: grayscale(1); opacity: 0.5; pointer-events: none; }
        .skill-cost { position: absolute; bottom: 2px; color: #00f2fe; font-weight: bold; }
        .control-row { display: flex; justify-content: space-between; align-items: center; }
        .speed-btn { background: #333; color: #aaa; border: 1px solid #555; padding: 5px 12px; border-radius: 15px; font-size: 12px; cursor: pointer; }
        .speed-btn.active { background: #ffcc00; color: #000; font-weight: bold; border-color: #ffcc00; }
        .spawn-btn { width: 100%; height: 50px; font-size: 20px; margin-top: 5px; }
        .content-scroll { flex: 1; overflow-y: auto; padding: 20px; }
        .stage-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 20px; }
        .stage-btn { aspect-ratio: 1; background: #333; border-radius: 8px; display: flex; justify-content: center; align-items: center; cursor: pointer; color: #666; border: 1px solid #444; font-size: 14px; }
        .stage-btn.unlocked { background: #222; color: white; border-color: #00f2fe; }
        .stage-btn.cleared { background: #003300; border-color: #00ff00; color: #00ff00; }
        .shop-item { background: #2a2a2a; border-radius: 10px; padding: 15px; margin-bottom: 10px; border: 1px solid #444; display: flex; align-items: center; }
        .item-icon { width: 50px; height: 50px; border-radius: 50%; background: #444; margin-right: 15px; display: flex; justify-content: center; align-items: center; font-size: 24px; }
        .item-info { flex: 1; text-align: left; }
        .deck-slot-container { display: flex; justify-content: center; gap: 10px; margin-bottom: 30px; }
        .deck-slot { width: 60px; height: 60px; border: 2px dashed #555; border-radius: 10px; display: flex; justify-content: center; align-items: center; color: #555; font-size: 12px; background: #111; position: relative; }
        .deck-slot.unlocked { border-style: solid; border-color: #00f2fe; color: #00f2fe; background: #1a1a2e; }
        .remove-skill { position: absolute; top: -5px; right: -5px; background: red; color: white; border-radius: 50%; width: 15px; height: 15px; display: flex; justify-content: center; align-items: center; cursor: pointer; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 200; display: none; justify-content: center; align-items: center; }
        .modal-content { background: #222; width: 80%; max-width: 300px; padding: 25px; border-radius: 15px; text-align: center; border: 1px solid #555; box-shadow: 0 0 30px rgba(0,255,255,0.2); }
    </style>
</head>
<body>

<div id="app">
    <div id="start-screen" class="screen active" style="justify-content: center; align-items: center; background: radial-gradient(#2b1055, #000);">
        <h1 style="font-size: 40px; color: #00f2fe; text-align: center;">ìš´ë¹¨ ì¡´ë§<br>ë””íœìŠ¤ V6</h1>
        <p style="color: #aaa;">ìë™ ë¦¬ì‚¬ì´ì§• ì ìš©</p>
        <button class="btn" onclick="GameApp.changeState('LOBBY')">í„°ì¹˜í•˜ì—¬ ì‹œì‘</button>
    </div>

    <div id="lobby-screen" class="screen">
        <div class="header"><span>ìŠ¤í…Œì´ì§€</span><span id="lobby-coin">ğŸ’° 0</span></div>
        <div class="content-scroll" id="stage-list-container"></div>
    </div>

    <div id="shop-screen" class="screen">
        <div class="header"><span>ìƒì </span><span id="shop-coin">ğŸ’° 0</span></div>
        <div class="content-scroll">
            <div style="color: #00f2fe; margin-bottom: 10px;">ğŸ² ì£¼ì‚¬ìœ„ ê°•í™”</div>
            <div id="dice-shop-container"></div>
            <hr style="border-color: #333; margin: 20px 0;">
            <div style="color: #ffcc00; margin-bottom: 10px;">âš¡ ìŠ¤í‚¬ êµ¬ë§¤</div>
            <div id="skill-shop-container"></div>
        </div>
    </div>

    <div id="deck-screen" class="screen">
        <div class="header"><span>ìŠ¤í‚¬ ì¥ì°©</span><span style="font-size: 14px; color: #aaa;">í•´ê¸ˆ í•„ìš”</span></div>
        <div class="content-scroll">
            <div class="deck-slot-container" id="equipped-skills-view"></div>
            <div style="text-align: center; color: #888; font-size: 14px; margin-bottom: 10px;">ë³´ìœ  ìŠ¤í‚¬</div>
            <div id="owned-skills-list"></div>
        </div>
    </div>

    <div id="game-screen" class="screen">
        <canvas id="gameCanvas"></canvas>
        <div id="game-ui">
            <div>
                <div class="game-top-bar"><span id="game-stage-txt">1-1</span><span id="game-life-txt">â¤ï¸ 3</span></div>
                <div class="time-bar-container"><div class="time-bar-fill" id="time-bar"></div></div>
            </div>
            <div class="game-footer">
                <div class="skill-bar" id="ingame-skill-bar"></div>
                <div class="control-row">
                    <span style="font-size: 14px; color: #aaa;">SP: <b id="game-sp-txt" style="color: #00f2fe; font-size: 20px;">0</b></span>
                    <div>
                        <button class="speed-btn active" onclick="Game.setSpeed(1, this)">x1</button>
                        <button class="speed-btn" onclick="Game.setSpeed(1.5, this)">x1.5</button>
                        <button class="speed-btn" onclick="Game.setSpeed(2, this)">x2</button>
                    </div>
                </div>
                <button class="btn spawn-btn" id="spawn-btn" onclick="Game.spawnDice()">ì£¼ì‚¬ìœ„ ì†Œí™˜ (10 SP)</button>
            </div>
        </div>
    </div>

    <div id="tab-bar">
        <div class="tab-item active" onclick="GameApp.changeState('LOBBY')"><div style="font-size:20px">âš”ï¸</div>ì „íˆ¬</div>
        <div class="tab-item locked-tab" id="tab-shop" onclick="GameApp.changeState('SHOP')"><div style="font-size:20px">ğŸ›’</div>ìƒì </div>
        <div class="tab-item locked-tab" id="tab-deck" onclick="GameApp.changeState('DECK')"><div style="font-size:20px">âš¡</div>ìŠ¤í‚¬</div>
    </div>
</div>

<div id="result-modal" class="modal">
    <div class="modal-content">
        <h2 id="result-title">CLEAR!</h2>
        <p id="result-msg">ë³´ìƒ: 100 ì½”ì¸</p>
        <button class="btn" onclick="Game.quitGame()">í™•ì¸</button>
    </div>
</div>

<script>
/** ìš´ë¹¨ ì¡´ë§ ë””íœìŠ¤ V6.0 (Auto-Resize Engine) **/
const DATA = {
    stages: [6, 10, 10, 14, 14],
    dice: {
        fire: { name: 'ë¶ˆ', color: '#ff4b2b' }, ice: { name: 'ì–¼ìŒ', color: '#00f2fe' },
        poison: { name: 'ë…', color: '#38ef7d' }, sniper: { name: 'ì €ê²©', color: '#d53369' }
    },
    skills: {
        arrow: { id: 'arrow', name: 'í™”ì‚´ë¹„', cost: 50, sp: 30, icon: 'ğŸ¹', desc: 'ì „ì²´ í”¼í•´' },
        lightning: { id: 'lightning', name: 'ë‚™ë¢°', cost: 150, sp: 50, icon: 'âš¡', desc: 'ë‹¨ì¼ í° í”¼í•´' },
        bombing: { id: 'bombing', name: 'ê³µì¤‘í­ê²©', cost: 300, sp: 80, icon: 'âœˆï¸', desc: 'ì „ì²´ ëŒ€ëŸ‰ í”¼í•´' },
        nuke: { id: 'nuke', name: 'í•µí­íƒ„', cost: 700, sp: 150, icon: 'â˜¢ï¸', desc: 'ì „ì²´ ì¦‰ì‚¬ê¸‰' }
    }
};

let player = { coins: 100, progress: { w: 1, s: 0 }, diceLv: { fire:1,ice:1,poison:1,sniper:1 }, ownedSkills: [], equippedSkills: [null,null,null] };

// --- ë©”ì¸ ê²Œì„ ì—”ì§„ ---
const Game = {
    canvas: null, ctx: null, loopId: null, 
    w: 360, h: 640, // ê¸°ë³¸ê°’ (ë‚˜ì¤‘ì— ë¦¬ì‚¬ì´ì§•ìœ¼ë¡œ ë®ì–´ì”Œì›Œì§)
    
    state: {},
    entities: { grid:[], enemies:[], bullets:[], particles:[] },
    selected: null,

    init() {
        this.canvas = document.getElementById('gameCanvas');
        this.ctx = this.canvas.getContext('2d');
        
        // ë¦¬ì‚¬ì´ì¦ˆ ì´ë²¤íŠ¸ ì—°ê²°
        window.addEventListener('resize', () => this.resize());
        this.resize(); // ì´ˆê¸° ì‹¤í–‰
        
        // í´ë¦­ ì´ë²¤íŠ¸ (ë¨¸ì§€)
        this.canvas.addEventListener('pointerdown', (e) => this.handleClick(e));
    },

    // í•µì‹¬: ê¸°ê¸° í™”ë©´ í¬ê¸°ì— ë§ì¶° ìº”ë²„ìŠ¤ ì¡°ì •
    resize() {
        if(!this.canvas) return;
        this.canvas.width = window.innerWidth;
        this.canvas.height = window.innerHeight;
        this.w = this.canvas.width;
        this.h = this.canvas.height;
        // ë¦¬ì‚¬ì´ì¦ˆ ì‹œ ì£¼ì‚¬ìœ„ ìœ„ì¹˜ ì¬ê³„ì‚°
        if(this.entities.grid.length > 0) {
            this.entities.grid.forEach(r => r.forEach(d => d && d.calcPos(this.w, this.h)));
        }
    },

    start(w, s) {
        GameApp.changeState('GAME');
        this.resize(); // ì‹œì‘ ì‹œ ê°•ì œ ë¦¬ì‚¬ì´ì§•
        this.initGameData(w, s);
        this.renderSkills();
        this.updateUI();
        if(this.loopId) cancelAnimationFrame(this.loopId);
        this.loop();
    },
    
    initGameData(w, s) {
        this.state = { world:w, stage:s, sp:0, spCost:10, time:90, lives:3, frame:0, speed:1, cd:[0,0,0] };
        this.entities = { grid: Array(4).fill().map(()=>Array(4).fill(null)), enemies:[], bullets:[], particles:[] };
        this.selected = null;
    },

    setSpeed(v, btn) { this.state.speed=v; document.querySelectorAll('.speed-btn').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); },
    
    spawnDice() {
        if(this.state.sp < this.state.spCost) return;
        let empty = []; for(let r=0;r<4;r++) for(let c=0;c<4;c++) if(!this.entities.grid[r][c]) empty.push({r,c});
        if(empty.length===0) return;
        this.state.sp -= this.state.spCost; this.state.spCost += 10;
        const p = empty[Math.floor(Math.random()*empty.length)];
        const k = ['fire','ice','poison','sniper'][Math.floor(Math.random()*4)];
        const d = new Dice(p.r, p.c, k);
        d.calcPos(this.w, this.h); // ìƒì„± ì‹œ ìœ„ì¹˜ ê³„ì‚°
        this.entities.grid[p.r][p.c] = d;
        this.eff(d.x, d.y, '#fff');
        this.updateUI();
    },

    handleClick(e) {
        // ì¢Œí‘œ ì •í™•ë„ í–¥ìƒ
        const rect = this.canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        
        const s = Math.min(this.w, this.h) / 5; // ë°˜ì‘í˜• ì‚¬ì´ì¦ˆ
        const ox = (this.w - s*4)/2;
        const oy = (this.h - s*4)/2;
        
        if(x>ox && x<ox+s*4 && y>oy && y<oy+s*4) {
            const c = Math.floor((x-ox)/s);
            const r = Math.floor((y-oy)/s);
            if(r>=0 && r<4 && c>=0 && c<4) {
                const clicked = this.entities.grid[r][c];
                if(clicked) {
                    if(this.selected && this.selected !== clicked && this.selected.t === clicked.t && this.selected.dots === clicked.dots) {
                        // ë¨¸ì§€
                        this.entities.grid[this.selected.r][this.selected.c] = null;
                        clicked.dots++; 
                        clicked.t = ['fire','ice','poison','sniper'][Math.floor(Math.random()*4)];
                        this.eff(clicked.x, clicked.y, '#fff');
                        this.selected = null;
                    } else {
                        this.selected = clicked;
                    }
                } else {
                    this.selected = null;
                }
            }
        }
    },

    // ë Œë”ë§ ë£¨í”„
    loop() {
        if(GameApp.state !== 'GAME') return;
        const cycles = this.state.speed>=2?2:1;
        
        // 1. ë¡œì§ ì—…ë°ì´íŠ¸
        for(let c=0; c<cycles; c++) {
            this.state.frame++;
            if(this.state.frame%60===0) { this.state.time--; if(this.state.time<=0) this.end(true); this.updateUI(); }
            if(this.state.frame%30===0) { this.state.sp++; this.updateUI(); }
            this.state.cd = this.state.cd.map(v=>v>0?v-1:0);
            
            // ì  ìŠ¤í°
            if(this.state.frame % Math.max(30, 120-(this.state.world*10)) === 0) {
                const en = new Enemy(this.state.world);
                en.calcPath(this.w, this.h);
                this.entities.enemies.push(en);
            }
            
            this.entities.grid.forEach(r=>r.forEach(d=>d&&d.update(this.entities.enemies)));
            this.entities.enemies.forEach(e=>e.update(this.state.speed/cycles));
            this.entities.bullets.forEach(b=>b.update(this.state.speed/cycles));
            
            this.entities.enemies = this.entities.enemies.filter(e=>e.active);
            this.entities.bullets = this.entities.bullets.filter(b=>b.active);
        }
        
        // 2. ê·¸ë¦¬ê¸° (í˜¸í™˜ì„± ë†’ì€ fillRect ì‚¬ìš©)
        this.ctx.fillStyle = '#1a1a2e'; 
        this.ctx.fillRect(0,0,this.w,this.h); // ì „ì²´ ë°°ê²½ ì§€ìš°ê¸°
        
        // ê²½ë¡œ ê·¸ë¦¬ê¸°
        this.ctx.strokeStyle = '#222'; this.ctx.lineWidth = 20; this.ctx.lineCap='round'; 
        this.ctx.beginPath();
        const path = getPath(this.w, this.h);
        this.ctx.moveTo(path[0].x, path[0].y); 
        path.forEach(p=>this.ctx.lineTo(p.x,p.y)); 
        this.ctx.stroke();

        this.entities.enemies.forEach(e=>e.draw(this.ctx));
        this.entities.grid.forEach(r=>r.forEach(d=>d&&d.draw(this.ctx, this.w, this.selected)));
        this.entities.bullets.forEach(b=>b.draw(this.ctx));
        this.entities.particles.forEach(p=>{p.update(); p.draw(this.ctx)});
        this.entities.particles = this.entities.particles.filter(p=>p.life>0);

        this.loopId = requestAnimationFrame(()=>this.loop());
    },

    // UI ë° ê¸°íƒ€ ê¸°ëŠ¥
    renderSkills() {
        const b = document.getElementById('ingame-skill-bar'); b.innerHTML = '';
        player.equippedSkills.forEach((id, i) => {
            if(!id) return;
            const s = DATA.skills[id];
            const el = document.createElement('div'); el.className = 'skill-btn'; el.id = `skill-${i}`;
            el.innerHTML = `<div style="font-size:20px">${s.icon}</div><div class="skill-cost">${s.sp}</div>`;
            el.onclick = () => this.useSkill(i, id);
            b.appendChild(el);
        });
    },
    useSkill(i, id) {
        const s = DATA.skills[id];
        if(this.state.sp >= s.sp && this.state.cd[i] <= 0) {
            this.state.sp -= s.sp; this.state.cd[i] = 600; 
            if(id==='arrow') this.entities.enemies.forEach(e=>{e.hp-=20; this.eff(e.x,e.y,'#fff')});
            if(id==='lightning') { const t = this.entities.enemies.reduce((a,b)=>a.hp>b.hp?a:b, {hp:-1}); if(t.active) {t.hp-=200; this.eff(t.x,t.y,'cyan');} }
            if(id==='bombing') { this.entities.enemies.forEach(e=>e.hp-=50); for(let k=0;k<10;k++) this.eff(Math.random()*this.w, Math.random()*this.h,'orange'); }
            if(id==='nuke') { this.entities.enemies.forEach(e=>e.hp-=9999); this.eff(this.w/2,this.h/2,'red'); }
            this.updateUI();
        }
    },
    updateUI() {
        document.getElementById('game-stage-txt').innerText = `${this.state.world}-${this.state.stage}`;
        document.getElementById('game-life-txt').innerText = `â¤ï¸ ${this.state.lives}`;
        document.getElementById('game-sp-txt').innerText = Math.floor(this.state.sp);
        document.getElementById('spawn-btn').innerText = `ì£¼ì‚¬ìœ„ ì†Œí™˜ (${this.state.spCost} SP)`;
        document.getElementById('time-bar').style.width = `${(this.state.time/90)*100}%`;
        player.equippedSkills.forEach((id,i)=>{
            if(!id) return;
            const btn = document.getElementById(`skill-${i}`);
            if(this.state.cd[i]>0 || this.state.sp < DATA.skills[id].sp) btn.classList.add('cooldown'); else btn.classList.remove('cooldown');
        });
    },
    end(win) {
        cancelAnimationFrame(this.loopId);
        document.getElementById('result-title').innerText = win?"CLEAR!":"GAME OVER";
        document.getElementById('result-title').style.color = win?"#00f2fe":"red";
        document.getElementById('result-msg').innerText = win?`ë³´ìƒ: 100 ì½”ì¸`:"ì¬ë„ì „í•˜ì„¸ìš”";
        if(win) {
            player.coins+=100;
            if(player.progress.w < this.state.world || (player.progress.w == this.state.world && player.progress.s < this.state.stage)) {
                player.progress.w = this.state.world; player.progress.s = this.state.stage;
            }
        }
        document.getElementById('result-modal').style.display = 'flex';
        GameApp.checkUnlocks();
    },
    quitGame() { document.getElementById('result-modal').style.display='none'; GameApp.changeState('LOBBY'); },
    eff(x,y,c) { for(let i=0;i<5;i++) this.entities.particles.push(new Particle(x,y,c)); }
};

// --- ì•± ë§¤ë‹ˆì € ---
const GameApp = {
    state: 'START',
    init() { 
        this.renderLobby(); this.checkUnlocks(); 
        Game.init(); // ê²Œì„ ì—”ì§„ ì´ˆê¸°í™” (ìº”ë²„ìŠ¤ ë°”ì¸ë”©)
    },
    changeState(newState) {
        document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
        document.getElementById('tab-bar').style.display = 'flex';
        if (newState === 'LOBBY') { document.getElementById('lobby-screen').classList.add('active'); this.renderLobby(); }
        else if (newState === 'SHOP') { document.getElementById('shop-screen').classList.add('active'); this.renderShop(); }
        else if (newState === 'DECK') { document.getElementById('deck-screen').classList.add('active'); this.renderDeck(); }
        else if (newState === 'GAME') {
            document.getElementById('game-screen').classList.add('active');
            document.getElementById('tab-bar').style.display = 'none';
        }
        this.checkUnlocks();
    },
    checkUnlocks() {
        if (this.isCleared(1, 6)) document.getElementById('tab-shop').classList.remove('locked-tab');
        if (this.isCleared(1, 4)) document.getElementById('tab-deck').classList.remove('locked-tab');
        document.getElementById('lobby-coin').innerText = `ğŸ’° ${player.coins}`;
        document.getElementById('shop-coin').innerText = `ğŸ’° ${player.coins}`;
    },
    isCleared(w, s) { return player.progress.w > w || (player.progress.w == w && player.progress.s >= s); },
    renderLobby() {
        const c = document.getElementById('stage-list-container'); c.innerHTML = '';
        DATA.stages.forEach((max, i) => {
            const w = i + 1; const d = document.createElement('div'); d.innerHTML = `<div style="margin:10px 0;color:#fff;">WORLD ${w}</div>`;
            const g = document.createElement('div'); g.className = 'stage-grid';
            for (let s = 1; s <= max; s++) {
                const btn = document.createElement('div'); btn.className = 'stage-btn'; btn.innerText = `${w}-${s}`;
                if (this.isCleared(w, s)) btn.classList.add('cleared');
                else if (this.isCleared(w, s - 1) || (w > 1 && s === 1 && this.isCleared(w-1, DATA.stages[w-2]))) {
                    btn.classList.add('unlocked'); btn.onclick = () => Game.start(w, s);
                } else { btn.innerHTML = 'ğŸ”’'; btn.style.opacity = 0.3; }
                g.appendChild(btn);
            }
            d.appendChild(g); c.appendChild(d);
        });
    },
    renderShop() {
        const dc = document.getElementById('dice-shop-container'); dc.innerHTML = '';
        Object.keys(DATA.dice).forEach(k => {
            const d = DATA.dice[k]; const cost = 500 * (k==='fire'?1:k==='ice'?2:k==='poison'?4:8);
            const el = document.createElement('div'); el.className = 'shop-item';
            el.innerHTML = `<div class="item-icon" style="color:${d.color}">ğŸ²</div><div class="item-info"><div>${d.name} (Lv.${player.diceLv[k]})</div><div style="color:gold">ğŸª™ ${cost}</div></div><button class="btn btn-buy" onclick="GameApp.buyDice('${k}',${cost})">ê°•í™”</button>`;
            dc.appendChild(el);
        });
        const sc = document.getElementById('skill-shop-container'); sc.innerHTML = '';
        Object.values(DATA.skills).forEach(s => {
            const owned = player.ownedSkills.includes(s.id);
            const el = document.createElement('div'); el.className = 'shop-item';
            el.innerHTML = `<div class="item-icon">${s.icon}</div><div class="item-info"><div>${s.name}</div><div style="font-size:12px;color:#aaa">${s.desc}</div><div style="color:gold">${owned?'ë³´ìœ ': 'ğŸª™ '+s.cost}</div></div><button class="btn btn-buy" ${owned?'disabled':''} onclick="GameApp.buySkill('${s.id}',${s.cost})">${owned?'ì™„ë£Œ':'êµ¬ë§¤'}</button>`;
            sc.appendChild(el);
        });
    },
    buyDice(id, c) { if(player.coins>=c){player.coins-=c; player.diceLv[id]++; alert('ê°•í™” ì™„ë£Œ!'); this.renderShop();} else alert('ì½”ì¸ ë¶€ì¡±'); },
    buySkill(id, c) { if(player.coins>=c){player.coins-=c; player.ownedSkills.push(id); alert('êµ¬ë§¤ ì™„ë£Œ!'); this.renderShop();} else alert('ì½”ì¸ ë¶€ì¡±'); },
    renderDeck() {
        const ec = document.getElementById('equipped-skills-view'); ec.innerHTML = '';
        const unlocks = [this.isCleared(1,4), this.isCleared(2,4), this.isCleared(3,10)];
        player.equippedSkills.forEach((id, i) => {
            const el = document.createElement('div'); el.className = `deck-slot ${unlocks[i]?'unlocked':''}`;
            if(!unlocks[i]) el.innerHTML = 'ğŸ”’';
            else if(id) { el.innerHTML = `<span style="font-size:24px">${DATA.skills[id].icon}</span><div class="remove-skill" onclick="GameApp.unequip(${i})">x</div>`; }
            else el.innerHTML = 'ë¹ˆ ìŠ¬ë¡¯';
            ec.appendChild(el);
        });
        const lc = document.getElementById('owned-skills-list'); lc.innerHTML = '';
        player.ownedSkills.forEach(id => {
            const s = DATA.skills[id]; const equipped = player.equippedSkills.includes(id);
            const el = document.createElement('div'); el.className = 'shop-item';
            el.innerHTML = `<div class="item-icon">${s.icon}</div><div class="item-info"><div>${s.name}</div><div style="color:#00f2fe">SP: ${s.sp}</div></div><button class="btn btn-equip" ${equipped?'disabled':''} onclick="GameApp.equip('${id}')">${equipped?'ì¥ì°©ì¤‘':'ì¥ì°©'}</button>`;
            lc.appendChild(el);
        });
    },
    equip(id) { const i = player.equippedSkills.findIndex((s,idx) => s===null && [this.isCleared(1,4), this.isCleared(2,4), this.isCleared(3,10)][idx]); if(i!==-1){player.equippedSkills[i]=id;this.renderDeck();} else alert('ë¹ˆ ìŠ¬ë¡¯ì´ ì—†ìŠµë‹ˆë‹¤.'); },
    unequip(i) { player.equippedSkills[i]=null; this.renderDeck(); }
};

// --- ì—”í‹°í‹° (í™”ë©´ í¬ê¸° ì˜ì¡´í˜•) ---
function getPath(w,h) { return [{x:w*0.1,y:0},{x:w*0.1,y:h*0.2},{x:w*0.9,y:h*0.2},{x:w*0.9,y:h*0.8},{x:w*0.1,y:h*0.8},{x:w*0.5,y:h*0.5}]; }

class Dice {
    constructor(r,c,t) { this.r=r;this.c=c;this.t=t;this.cd=0; this.dots=1; }
    calcPos(w, h) { const s=Math.min(w,h)/5, ox=(w-s*4)/2, oy=(h-s*4)/2; this.x=ox+this.c*s+s/2; this.y=oy+this.r*s+s/2; this.size = s; }
    update(ens) {
        if(this.cd>0) {this.cd--; return;}
        const rng=this.t==='sniper'?999:this.size*2.5;
        let t=null, max=-1;
        for(let e of ens) if(Math.hypot(e.x-this.x, e.y-this.y)<=rng && e.travel>max) {max=e.travel; t=e;}
        if(t) {
            Game.entities.bullets.push(new Bullet(this.x,this.y,t,this.t, 10*this.dots*(1+player.diceLv[this.t]*0.2)));
            this.cd = this.t==='sniper'?120:(this.t==='ice'?40:60);
        }
    }
    draw(ctx, w, selected) {
        if(!this.size) return;
        const s = this.size * 0.8;
        ctx.save(); ctx.translate(this.x, this.y);
        ctx.fillStyle = DATA.dice[this.t].color;
        ctx.fillRect(-s/2,-s/2,s,s);
        if(selected === this) { ctx.strokeStyle = 'white'; ctx.lineWidth = 3; ctx.strokeRect(-s/2, -s/2, s, s); }
        ctx.fillStyle='#fff'; ctx.font='bold 16px Arial'; ctx.textAlign='center'; ctx.textBaseline='middle';
        ctx.fillText(this.dots,0,0); ctx.restore();
    }
}

class Enemy {
    constructor(w) { this.hp=50+w*50; this.max=this.hp; this.active=true; this.travel=0; this.idx=1; }
    calcPath(w,h) { this.path = getPath(w,h); this.x=this.path[0].x; this.y=this.path[0].y; }
    update(spd) {
        if(!this.active || !this.path) return;
        const t=this.path[this.idx], dx=t.x-this.x, dy=t.y-this.y, d=Math.hypot(dx,dy), mv=2*spd;
        if(d<=mv) { this.x=t.x; this.y=t.y; this.idx++; if(this.idx>=this.path.length) {this.active=false; Game.state.lives--; Game.updateUI(); if(Game.state.lives<=0) Game.end(false);} }
        else { this.x+=dx/d*mv; this.y+=dy/d*mv; this.travel+=mv; }
    }
    draw(ctx) {
        ctx.fillStyle='red'; ctx.beginPath(); ctx.arc(this.x,this.y,12,0,Math.PI*2); ctx.fill();
        ctx.fillStyle='#0f0'; ctx.fillRect(this.x-10,this.y-18,20*(this.hp/this.max),4);
    }
}

class Bullet {
    constructor(x,y,t,type,d) { this.x=x;this.y=y;this.t=t;this.type=type;this.d=d;this.active=true; }
    update(spd) {
        if(!this.t.active) {this.active=false; return;}
        const dx=this.t.x-this.x, dy=this.t.y-this.y, dist=Math.hypot(dx,dy), mv=15*spd;
        if(dist<mv) {
            this.active=false; this.t.hp-=this.d; Game.eff(this.x,this.y,DATA.dice[this.type].color);
            if(this.t.hp<=0) {this.t.active=false; Game.state.sp+=2; Game.updateUI();}
        } else { this.x+=dx/dist*mv; this.y+=dy/dist*mv; }
    }
    draw(ctx) { ctx.fillStyle=DATA.dice[this.type].color; ctx.beginPath(); ctx.arc(this.x,this.y,4,0,Math.PI*2); ctx.fill(); }
}

class Particle {
    constructor(x,y,c) { this.x=x;this.y=y;this.c=c; this.vx=(Math.random()-0.5)*5; this.vy=(Math.random()-0.5)*5; this.life=1.0; }
    update() { this.x+=this.vx; this.y+=this.vy; this.life-=0.1; }
    draw(ctx) { ctx.globalAlpha=this.life; ctx.fillStyle=this.c; ctx.beginPath(); ctx.arc(this.x,this.y,3,0,Math.PI*2); ctx.fill(); ctx.globalAlpha=1; }
}

GameApp.init();
</script>
</body>
</html>
